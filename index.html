<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ABUNDA LEGAL | Voice Interface</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Space+Mono&display=swap" rel="stylesheet">

    <style>
        body { background-color: #050505; color: #D4AF37; font-family: 'Space Mono', monospace; overflow: hidden; }
        .font-cinzel { font-family: 'Cinzel', serif; }
        
        /* El Orbe Místico */
        .orb-container {
            position: relative;
            width: 220px;
            height: 220px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .orb-container:active { transform: scale(0.95); }

        .orb {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #FFD700, #B8860B, #000);
            box-shadow: 0 0 60px rgba(212, 175, 55, 0.2);
            animation: breathe 6s infinite ease-in-out;
            z-index: 10;
            position: relative;
        }
        
        .orb::after {
            content: '';
            position: absolute;
            inset: -10px;
            border-radius: 50%;
            border: 1px solid rgba(212, 175, 55, 0.1);
            animation: spin 20s linear infinite;
        }

        .orb.listening {
            animation: pulse-blue 1.5s infinite;
            background: radial-gradient(circle at 30% 30%, #4facfe, #00f2fe, #000);
            box-shadow: 0 0 100px rgba(0, 242, 254, 0.4);
        }

        .orb.processing {
            animation: vibrate 0.1s infinite;
            background: radial-gradient(circle at 30% 30%, #ff9a9e, #fecfef, #000);
            box-shadow: 0 0 80px rgba(255, 154, 158, 0.4);
        }

        @keyframes breathe { 0%, 100% { transform: scale(1); box-shadow: 0 0 60px rgba(212, 175, 55, 0.2); } 50% { transform: scale(1.02); box-shadow: 0 0 90px rgba(212, 175, 55, 0.4); } }
        @keyframes pulse-blue { 0%, 100% { transform: scale(1); box-shadow: 0 0 60px rgba(79, 172, 254, 0.3); } 50% { transform: scale(1.1); box-shadow: 0 0 120px rgba(79, 172, 254, 0.6); } }
        @keyframes vibrate { 0% { transform: translate(0); } 20% { transform: translate(-2px, 2px); } 40% { transform: translate(-2px, -2px); } 60% { transform: translate(2px, 2px); } 80% { transform: translate(2px, -2px); } 100% { transform: translate(0); } }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        .star-field {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-image: radial-gradient(rgba(255,255,255,0.1) 1px, transparent 1px);
            background-size: 40px 40px;
            opacity: 0.3;
            z-index: 0;
            pointer-events: none;
        }
        
        .legal-frame {
            border: 1px solid rgba(212, 175, 55, 0.3);
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(10px);
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center h-screen relative selection:bg-[#D4AF37] selection:text-black">

    <div class="star-field"></div>

    <!-- Header -->
    <div class="absolute top-12 text-center z-20">
        <div class="flex items-center justify-center gap-3 mb-2">
            <i class="ph ph-scales text-3xl text-[#D4AF37]"></i>
            <h1 class="font-cinzel text-4xl md:text-5xl font-bold tracking-widest text-transparent bg-clip-text bg-gradient-to-r from-[#D4AF37] via-[#FFF] to-[#D4AF37]">ABUNDA LEGAL</h1>
        </div>
        <p class="text-[10px] md:text-xs tracking-[0.4em] uppercase text-[#D4AF37]/70">Sistema Jurídico de Voz • Powered by Maximus</p>
    </div>

    <!-- The Core -->
    <div class="z-20 flex flex-col items-center w-full max-w-4xl px-6">
        
        <div id="orb-trigger" class="orb-container mb-16 group">
            <div id="orb-visual" class="orb flex items-center justify-center">
                <i class="ph ph-microphone text-4xl text-black/50 opacity-0 group-hover:opacity-100 transition duration-500"></i>
            </div>
        </div>

        <div id="status-text" class="text-[#D4AF37] text-sm uppercase tracking-widest mb-8 animate-pulse font-bold">
            Toque el Núcleo para Consultar
        </div>

        <!-- Transcript & Response Box -->
        <div class="w-full legal-frame rounded-xl p-8 min-h-[200px] flex flex-col justify-center items-center text-center relative overflow-hidden group">
            <div class="absolute top-0 left-0 w-2 h-2 border-t border-l border-[#D4AF37]"></div>
            <div class="absolute top-0 right-0 w-2 h-2 border-t border-r border-[#D4AF37]"></div>
            <div class="absolute bottom-0 left-0 w-2 h-2 border-b border-l border-[#D4AF37]"></div>
            <div class="absolute bottom-0 right-0 w-2 h-2 border-b border-r border-[#D4AF37]"></div>
            
            <p id="user-transcript" class="text-xs text-gray-500 mb-4 font-mono hidden">Escuchando...</p>
            <p id="response-text" class="text-white/90 text-lg md:text-xl font-light leading-relaxed font-cinzel">Esperando consulta jurídica...</p>
        </div>
    </div>

    <!-- Footer -->
    <div class="absolute bottom-8 flex gap-6 z-20 opacity-50 text-[10px] text-[#D4AF37] uppercase tracking-widest">
        <span class="flex items-center gap-1"><i class="ph ph-lock-key"></i> Encriptado</span>
        <span class="flex items-center gap-1"><i class="ph ph-gavel"></i> Lex Consult</span>
        <span class="flex items-center gap-1"><i class="ph ph-globe"></i> Online</span>
    </div>

    <script>
        // ==========================================
        // CONFIGURACIÓN (SOBERANO: CAMBIE ESTO)
        // ==========================================
        const API_URL = "https://infinity-1a8b0e60d47c.herokuapp.com"; // Su App de Heroku Legal
        // ==========================================

        const orb = document.getElementById('orb-visual');
        const status = document.getElementById('status-text');
        const responseBox = document.getElementById('response-text');
        const userBox = document.getElementById('user-transcript');
        const trigger = document.getElementById('orb-trigger');

        let recognition;
        let synthesis = window.speechSynthesis;

        // Configurar Voz (Web Speech API)
        if ('webkitSpeechRecognition' in window) {
            recognition = new webkitSpeechRecognition();
            recognition.continuous = false;
            recognition.lang = 'es-CR'; // Español Costa Rica (o es-ES)
            recognition.interimResults = true;

            recognition.onstart = () => {
                orb.classList.add('listening');
                orb.classList.remove('processing');
                status.innerText = "Escuchando su caso...";
                userBox.classList.remove('hidden');
                userBox.innerText = "...";
                responseBox.classList.add('opacity-50');
            };

            recognition.onend = () => {
                orb.classList.remove('listening');
                orb.classList.add('processing');
                status.innerText = "Analizando Jurisprudencia...";
            };

            recognition.onresult = async (event) => {
                const transcript = event.results[0][0].transcript;
                userBox.innerText = `"${transcript}"`;
                if(event.results[0].isFinal) {
                    await askLegalBrain(transcript);
                }
            };
        } else {
            responseBox.innerText = "Navegador no compatible con voz. Use Chrome.";
        }

        async function askLegalBrain(question) {
            try {
                // Llamada al Backend de Heroku
                const response = await fetch(`${API_URL}/api/chat`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        message: question,
                        history: [] // Historial limpio para cada consulta rápida de voz
                    })
                });

                if (!response.ok) throw new Error("Error del servidor");

                const data = await response.json();
                const answer = data.response; // Ajustado al formato de su backend
                
                orb.classList.remove('processing');
                status.innerText = "Dictamen Listo";
                responseBox.classList.remove('opacity-50');
                
                typeWriter(answer);
                speak(answer);

            } catch (error) {
                console.error(error);
                orb.classList.remove('processing');
                status.innerText = "Error de Conexión";
                responseBox.innerText = "No se pudo contactar al servidor legal. Verifique la URL.";
            }
        }

        function typeWriter(text) {
            responseBox.innerText = "";
            let i = 0;
            const speed = 20; 
            function type() {
                if (i < text.length) {
                    responseBox.innerHTML += text.charAt(i);
                    i++;
                    setTimeout(type, speed);
                }
            }
            type();
        }

        function speak(text) {
            if (synthesis.speaking) synthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'es-ES';
            // Intentar voz seria
            const voices = synthesis.getVoices();
            const seriousVoice = voices.find(v => v.lang.includes('es') && v.name.includes('Google'));
            if(seriousVoice) utterance.voice = seriousVoice;
            synthesis.speak(utterance);
        }

        trigger.addEventListener('mousedown', () => { if(recognition) recognition.start(); });
        trigger.addEventListener('touchstart', (e) => { e.preventDefault(); if(recognition) recognition.start(); });

    </script>
</body>

</html>
